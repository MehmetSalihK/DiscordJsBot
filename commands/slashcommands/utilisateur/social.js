import { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } from 'discord.js';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { Emojis, createInfoEmbed, createErrorEmbed, createSuccessEmbed } from '../../../src/utils/embeds.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const socialsPath = path.join(__dirname, '../../../json/socials.json');

// Fonction pour lire les donn√©es sociales
function readSocialsData() {
    try {
        if (!fs.existsSync(socialsPath)) {
            fs.writeFileSync(socialsPath, '{}');
            return {};
        }
        const data = fs.readFileSync(socialsPath, 'utf8');
        return JSON.parse(data);
    } catch (error) {
        console.error('[SOCIAL] Erreur lors de la lecture:', error);
        return {};
    }
}

// Fonction pour sauvegarder les donn√©es sociales
function saveSocialsData(data) {
    try {
        fs.writeFileSync(socialsPath, JSON.stringify(data, null, 2));
        return true;
    } catch (error) {
        console.error('[SOCIAL] Erreur lors de la sauvegarde:', error);
        return false;
    }
}

// Configuration des r√©seaux sociaux support√©s
const supportedNetworks = {
    twitter: { emoji: 'üê¶', name: 'Twitter', baseUrl: 'https://twitter.com/' },
    instagram: { emoji: 'üì∏', name: 'Instagram', baseUrl: 'https://instagram.com/' },
    github: { emoji: 'üíª', name: 'GitHub', baseUrl: 'https://github.com/' },
    twitch: { emoji: 'üéÆ', name: 'Twitch', baseUrl: 'https://twitch.tv/' },
    youtube: { emoji: 'üì∫', name: 'YouTube', baseUrl: 'https://youtube.com/@' },
    tiktok: { emoji: 'üéµ', name: 'TikTok', baseUrl: 'https://tiktok.com/@' },
    discord: { emoji: 'üí¨', name: 'Discord', baseUrl: '' },
    linkedin: { emoji: 'üíº', name: 'LinkedIn', baseUrl: 'https://linkedin.com/in/' }
};

export default {
    data: new SlashCommandBuilder()
        .setName('social')
        .setDescription('üåê G√©rer vos profils de r√©seaux sociaux')
        .addSubcommand(subcommand =>
            subcommand
                .setName('add')
                .setDescription('‚ûï Ajouter ou modifier un r√©seau social')
                .addStringOption(option =>
                    option
                        .setName('r√©seau')
                        .setDescription('Le r√©seau social √† configurer')
                        .setRequired(true)
                        .addChoices(
                            { name: 'üê¶ Twitter', value: 'twitter' },
                            { name: 'üì∏ Instagram', value: 'instagram' },
                            { name: 'üíª GitHub', value: 'github' },
                            { name: 'üéÆ Twitch', value: 'twitch' },
                            { name: 'üì∫ YouTube', value: 'youtube' },
                            { name: 'üéµ TikTok', value: 'tiktok' },
                            { name: 'üí¨ Discord', value: 'discord' },
                            { name: 'üíº LinkedIn', value: 'linkedin' }
                        ))
                .addStringOption(option =>
                    option
                        .setName('identifiant')
                        .setDescription('Votre nom d\'utilisateur (sans @)')
                        .setRequired(true))
                .addStringOption(option =>
                    option
                        .setName('lien')
                        .setDescription('Lien direct vers votre profil (optionnel)')
                        .setRequired(false))
                .addStringOption(option =>
                    option
                        .setName('confidentialit√©')
                        .setDescription('Visibilit√© de votre profil')
                        .setRequired(false)
                        .addChoices(
                            { name: 'üåç Public', value: 'public' },
                            { name: 'üîí Priv√©', value: 'priv√©' }
                        )))
        .addSubcommand(subcommand =>
            subcommand
                .setName('remove')
                .setDescription('üóëÔ∏è Supprimer un r√©seau social')
                .addStringOption(option =>
                    option
                        .setName('r√©seau')
                        .setDescription('Le r√©seau social √† supprimer')
                        .setRequired(true)
                        .addChoices(
                            { name: 'üê¶ Twitter', value: 'twitter' },
                            { name: 'üì∏ Instagram', value: 'instagram' },
                            { name: 'üíª GitHub', value: 'github' },
                            { name: 'üéÆ Twitch', value: 'twitch' },
                            { name: 'üì∫ YouTube', value: 'youtube' },
                            { name: 'üéµ TikTok', value: 'tiktok' },
                            { name: 'üí¨ Discord', value: 'discord' },
                            { name: 'üíº LinkedIn', value: 'linkedin' }
                        )))
        .addSubcommand(subcommand =>
            subcommand
                .setName('list')
                .setDescription('üìã Afficher tous vos r√©seaux sociaux configur√©s'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('panel')
                .setDescription('‚öôÔ∏è Panneau de gestion interactif des r√©seaux sociaux')),

    async execute(interaction) {
        const subcommand = interaction.options.getSubcommand();
        const userId = interaction.user.id;

        switch (subcommand) {
            case 'add':
                await handleAddSocial(interaction, userId);
                break;
            case 'remove':
                await handleRemoveSocial(interaction, userId);
                break;
            case 'list':
                await handleListSocials(interaction, userId);
                break;
            case 'panel':
                await handleSocialPanel(interaction, userId);
                break;
        }
    }
};

async function handleAddSocial(interaction, userId) {
    const network = interaction.options.getString('r√©seau');
    const username = interaction.options.getString('identifiant');
    const customLink = interaction.options.getString('lien');
    const privacy = interaction.options.getString('confidentialit√©') || 'public';

    // Validation du nom d'utilisateur
    const cleanUsername = username.replace(/^@/, ''); // Supprimer @ si pr√©sent
    
    // G√©n√©rer le lien automatiquement si pas fourni
    let finalLink = customLink;
    if (!customLink && supportedNetworks[network]) {
        if (network === 'discord') {
            finalLink = cleanUsername; // Pour Discord, on garde juste le tag
        } else {
            finalLink = supportedNetworks[network].baseUrl + cleanUsername;
        }
    }

    // Lire les donn√©es existantes
    const socialsData = readSocialsData();
    
    // Initialiser l'utilisateur s'il n'existe pas
    if (!socialsData[userId]) {
        socialsData[userId] = {};
    }

    // V√©rifier si c'est une mise √† jour
    const isUpdate = socialsData[userId][network] !== undefined;

    // Ajouter/mettre √† jour le r√©seau social
    socialsData[userId][network] = {
        username: cleanUsername,
        link: finalLink || 'non d√©fini',
        privacy: privacy
    };

    // Sauvegarder
    if (saveSocialsData(socialsData)) {
        const networkInfo = supportedNetworks[network];
        const embed = new EmbedBuilder()
            .setColor('#00ff00')
            .setTitle(`${Emojis.success} R√©seau social ${isUpdate ? 'mis √† jour' : 'ajout√©'}`)
            .setDescription(`${networkInfo.emoji} **${networkInfo.name}** a √©t√© ${isUpdate ? 'mis √† jour' : 'configur√©'} avec succ√®s !`)
            .addFields(
                { name: 'üë§ Identifiant', value: `\`${cleanUsername}\``, inline: true },
                { name: 'üîó Lien', value: finalLink === 'non d√©fini' ? '`non d√©fini`' : `[Voir le profil](${finalLink})`, inline: true },
                { name: 'üîí Confidentialit√©', value: privacy === 'public' ? 'üåç Public' : 'üîí Priv√©', inline: true }
            )
            .setTimestamp()
            .setFooter({ text: `Demand√© par ${interaction.user.tag}`, iconURL: interaction.user.displayAvatarURL() });

        console.log(`[SOCIAL] ${isUpdate ? 'Mise √† jour' : 'Ajout'} - ${interaction.user.tag} (${userId}) : ${network} ‚Üí ${cleanUsername}`);
        
        await interaction.reply({ embeds: [embed] });
    } else {
        const errorEmbed = new EmbedBuilder()
            .setColor('#ff0000')
            .setTitle(`${Emojis.error} Erreur`)
            .setDescription('Une erreur est survenue lors de la sauvegarde. Veuillez r√©essayer.')
            .setTimestamp();

        await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
    }
}

async function handleRemoveSocial(interaction, userId) {
    const network = interaction.options.getString('r√©seau');
    
    // Lire les donn√©es existantes
    const socialsData = readSocialsData();
    
    // V√©rifier si l'utilisateur et le r√©seau existent
    if (!socialsData[userId] || !socialsData[userId][network]) {
        const embed = new EmbedBuilder()
            .setColor('#ff0000')
            .setTitle(`${Emojis.error} Profil non trouv√©`)
            .setDescription(`Vous n'avez pas configur√© de profil **${supportedNetworks[network].name}**.`)
            .setTimestamp();

        await interaction.reply({ embeds: [embed], ephemeral: true });
        return;
    }

    // Supprimer le r√©seau social
    const removedData = socialsData[userId][network];
    delete socialsData[userId][network];

    // Supprimer l'utilisateur enti√®rement s'il n'a plus de r√©seaux
    if (Object.keys(socialsData[userId]).length === 0) {
        delete socialsData[userId];
    }

    // Sauvegarder
    if (saveSocialsData(socialsData)) {
        const networkInfo = supportedNetworks[network];
        const embed = new EmbedBuilder()
            .setColor('#00ff00')
            .setTitle(`${Emojis.success} R√©seau social supprim√©`)
            .setDescription(`${networkInfo.emoji} Votre profil **${networkInfo.name}** (\`${removedData.username}\`) a √©t√© supprim√© avec succ√®s.`)
            .setTimestamp()
            .setFooter({ text: `Demand√© par ${interaction.user.tag}`, iconURL: interaction.user.displayAvatarURL() });

        console.log(`[SOCIAL] Suppression - ${interaction.user.tag} (${userId}) : ${network} ‚Üí ${removedData.username}`);
        
        await interaction.reply({ embeds: [embed] });
    } else {
        const errorEmbed = new EmbedBuilder()
            .setColor('#ff0000')
            .setTitle(`${Emojis.error} Erreur`)
            .setDescription('Une erreur est survenue lors de la suppression. Veuillez r√©essayer.')
            .setTimestamp();

        await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
    }
}

async function handleListSocials(interaction, userId) {
    const socialsData = readSocialsData();
    const userSocials = socialsData[userId];

    const embed = new EmbedBuilder()
        .setColor('#0099ff')
        .setTitle(`${Emojis.user} Profils sociaux de ${interaction.user.displayName}`)
        .setThumbnail(interaction.user.displayAvatarURL())
        .setTimestamp()
        .setFooter({ text: `Demand√© par ${interaction.user.tag}`, iconURL: interaction.user.displayAvatarURL() });

    if (!userSocials || Object.keys(userSocials).length === 0) {
        embed.setDescription(`${Emojis.warning} Aucun r√©seau social configur√©.\n\nUtilisez \`/social add\` pour ajouter vos profils !`);
        await interaction.reply({ embeds: [embed] });
        return;
    }

    let description = '';
    let configuredCount = 0;

    // Parcourir tous les r√©seaux support√©s
    for (const [networkKey, networkInfo] of Object.entries(supportedNetworks)) {
        if (userSocials[networkKey]) {
            const social = userSocials[networkKey];
            const privacyIcon = social.privacy === 'public' ? 'üåç' : 'üîí';
            const linkText = social.link === 'non d√©fini' ? 'Aucun lien' : `[Voir le profil](${social.link})`;
            
            description += `${networkInfo.emoji} **${networkInfo.name}** : \`@${social.username}\` ${privacyIcon}\n`;
            if (social.link !== 'non d√©fini') {
                description += `‚îî ${linkText}\n`;
            }
            description += '\n';
            configuredCount++;
        } else {
            description += `${networkInfo.emoji} **${networkInfo.name}** : \`Aucun\`\n\n`;
        }
    }

    embed.setDescription(description);
    embed.addFields({
        name: 'üìä Statistiques',
        value: `**${configuredCount}** r√©seau${configuredCount > 1 ? 'x' : ''} configur√©${configuredCount > 1 ? 's' : ''}`,
        inline: true
    });

    await interaction.reply({ embeds: [embed] });
}

async function handleSocialPanel(interaction, userId) {
    // Lire les donn√©es existantes
    let socialsData = {};
    try {
        const data = fs.readFileSync(socialsPath, 'utf8');
        socialsData = JSON.parse(data);
    } catch (error) {
        // Fichier n'existe pas encore ou est vide
    }

    const userSocials = socialsData[userId] || {};
    const configuredNetworks = Object.keys(userSocials);
    const configuredCount = configuredNetworks.length;

    // Cr√©er l'embed du panneau
    const embed = createInfoEmbed(
        '‚öôÔ∏è Configuration des r√©seaux sociaux',
        `**G√©rez vos profils de r√©seaux sociaux**\n\n` +
            `üîß **Ajouter un profil** ‚Üí Utilisez \`/social add\`\n` +
            `üóëÔ∏è **Supprimer un profil** ‚Üí Cliquez sur le bouton Supprimer\n` +
            `‚úèÔ∏è **Modifier un profil** ‚Üí Cliquez sur le bouton Modifier\n` +
            `üëÅÔ∏è **Confidentialit√©** ‚Üí Basculez entre Public/Priv√©\n\n` +
            `üìä **R√©seaux configur√©s** : ${configuredCount}`,
        { footer: 'Utilisez les boutons ci-dessous pour g√©rer vos r√©seaux' }
    ).setColor('#9b59b6');

    // Cr√©er les boutons
    
    const row = new ActionRowBuilder()
        .addComponents(
            new ButtonBuilder()
                .setCustomId('social_add')
                .setLabel('Ajouter')
                .setEmoji('‚ûï')
                .setStyle(ButtonStyle.Success),
            new ButtonBuilder()
                .setCustomId('social_remove')
                .setLabel('Supprimer')
                .setEmoji('üóëÔ∏è')
                .setStyle(ButtonStyle.Danger)
                .setDisabled(configuredCount === 0),
            new ButtonBuilder()
                .setCustomId('social_edit')
                .setLabel('Modifier')
                .setEmoji('‚úèÔ∏è')
                .setStyle(ButtonStyle.Primary)
                .setDisabled(configuredCount === 0),
            new ButtonBuilder()
                .setCustomId('social_privacy')
                .setLabel('Confidentialit√©')
                .setEmoji('üëÅÔ∏è')
                .setStyle(ButtonStyle.Secondary)
                .setDisabled(configuredCount === 0)
        );

    await interaction.reply({ embeds: [embed], components: [row] });
}